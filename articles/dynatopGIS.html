<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Building a Dynamic TOPMODEL • dynatopGIS</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Building a Dynamic TOPMODEL">
<meta property="og:description" content="dynatopGIS">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">dynatopGIS</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.3.0.1010</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/dynatopGIS.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Banding.html">Distance Classification</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/waternumbers/dynatopGIS/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Building a Dynamic TOPMODEL</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/waternumbers/dynatopGIS/blob/HEAD/vignettes/dynatopGIS.Rmd" class="external-link"><code>vignettes/dynatopGIS.Rmd</code></a></small>
      <div class="hidden name"><code>dynatopGIS.Rmd</code></div>

    </div>

    
    
<p>The purpose of this vignette is to provide an outline of the steps
needed to build a dynamic TOPMODEL implementation using the dynatopGIS
package.</p>
<div class="section level2">
<h2 id="implementation-notes">Implementation notes<a class="anchor" aria-label="anchor" href="#implementation-notes"></a>
</h2>
<p>The dynatopGIS package implements a structured, object orientated,
data flow. The steps outlined below create a <code>dynatopGIS</code>
catchment object to which actions are then applied to generate a
model.</p>
<p>The <code>dynatopGIS</code> package is written using the object
orientated framework provided by the <code>R6</code> package. This means
that some aspects of working with the objects may appear idiosyncratic
for some R users. In using the package as outlined in this vignette
these problems are largely obscured, except for the call structure.
However, before adapting the code, or doing more complex analysis users
should read about <code>R6</code> class objects (e.g. in the
<code>R6</code> package vignettes or in the Advanced R book). One
particular gotcha is when copying an object. Using</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_new_object</span>  <span class="op">&lt;-</span>  <span class="va">my_object</span></span></code></pre></div>
<p>creates a pointer, that is altering <code>my_new_object</code> also
alters <code>my_object</code>. To create a new independent copy of
<code>my_object</code> use</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_new_object</span>  <span class="op">&lt;-</span>  <span class="va">my_object</span><span class="op">$</span><span class="fu">clone</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="getting-started">Getting started<a class="anchor" aria-label="anchor" href="#getting-started"></a>
</h2>
<p>The dynatopGIS packages works through a number of steps to generate a
Dynamic TOPMODEL object suitable for use in with the
<code>dynatop</code> package. Each step generates one or more layers
which are saved as raster or shape files into the projects working
directory (which is not necessarily the R working directory). A record
of these layers is kept in the json format meta data file.</p>
<p>This vignette demonstrates the use of the <code>dynatopGIS</code>
package using data from the Swindale catchment in the UK.</p>
<p>To start first load the library</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://waternumbers.github.io/dynatopGIS/" class="external-link">"dynatopGIS"</a></span><span class="op">)</span></span></code></pre></div>
<p>For this vignette we will store the data into a temporary
directory</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">demo_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="st">"dygis"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">demo_dir</span><span class="op">)</span></span></code></pre></div>
<p>and initialise the analysis by creating a new object specifying the
location of the meta data file, which will be created if it doesn’t
exist.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctch</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/dynatopGIS.html">dynatopGIS</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">demo_dir</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Starting new project at /tmp/RtmpYJ5ZBV/dygis1c2a3f5734d8</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="adding-catchment-data">Adding catchment data<a class="anchor" aria-label="anchor" href="#adding-catchment-data"></a>
</h2>
<p>The basis of the analysis is a rasterised Digital Elevation Model
(DEM) of the catchment and a vectorised representation of the river
network with attributes. Currently these can be in any format supported
by the <code>terra</code> library.</p>
<p>However, within the calculations used for sink filling, flow routing
and topographic index calculations the raster DEM is presumed to be
projected so that is has square cells such that the difference between
the cell centres (in meters) does not alter.</p>
<p>For Swindale the suitable DEM and channel files can be found
using:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dem_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"SwindaleDTM40m.tif"</span>, package<span class="op">=</span><span class="st">"dynatopGIS"</span>, mustWork <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">channel_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"SwindaleRiverNetwork.shp"</span>, package<span class="op">=</span><span class="st">"dynatopGIS"</span>, mustWork <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Before adding either the DEM or channel a raster map of the catchment
outline must be provided. This defines not only the catchment boundaries
but also, if required, subcatchments, each of which must be given a
unique number. The projection and resolution of this map is used in all
subsequent GIS processing</p>
<p>In this example the catchment map is generated from the DEM, which,
by convention must contain a edge rows and columns containing only
<code>NA</code> values.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dem</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">dem_file</span><span class="op">)</span></span>
<span><span class="va">dem</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extend.html" class="external-link">extend</a></span><span class="op">(</span><span class="va">dem</span>,<span class="fl">1</span><span class="op">)</span> <span class="co">## pad with NA values</span></span>
<span><span class="va">catchment_outline</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/ifelse.html" class="external-link">ifel</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">dem</span><span class="op">)</span>,<span class="fl">1</span>,<span class="cn">NA</span><span class="op">)</span></span>
<span><span class="va">ctch</span><span class="op">$</span><span class="fu">add_catchment</span><span class="op">(</span><span class="va">catchment_outline</span><span class="op">)</span></span></code></pre></div>
<p>Either the DEM or channel files can be added to the project first. In
this case we add the DEM with</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctch</span><span class="op">$</span><span class="fu">add_dem</span><span class="op">(</span><span class="va">dem</span><span class="op">)</span></span></code></pre></div>
<p>Adding river channel data is more complex. The
<code>add_channel</code> method requires a <code>SpatVector</code>
object (or a file name that can be loaded as a <code>SpatVect</code>
object). Each vector object is treated as a length of river channel
which requires the following properties</p>
<ul>
<li>
<em>name</em> - a label for the channel length</li>
<li>
<em>endNode</em> - a label for the downstream end of the river
length</li>
<li>
<em>startNode</em> - a label for the upstream end of the river
length</li>
<li>
<em>length</em> - the length in meters</li>
<li>
<em>area</em> - surface area in square meters</li>
<li>
<em>width</em> - width of the channel</li>
<li>
<em>slope</em> - bed slope of the channel</li>
</ul>
<p>Additional properties are currently kept but ignored with the
exception of <em>id</em> which is overwritten.</p>
<p>Since it is possible that these properties are present in a data file
under different names some basic preprocessing may be required. The
<code>convert_channel</code> function is designed to help with this. To
illustrate this let us examine the river network for Swindale</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sp_lines</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="va">channel_file</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: [vect] Z coordinates ignored</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">sp_lines</span><span class="op">)</span></span>
<span><span class="co">#&gt;  class       : SpatVector </span></span>
<span><span class="co">#&gt;  geometry    : lines </span></span>
<span><span class="co">#&gt;  dimensions  : 6, 11  (geometries, attributes)</span></span>
<span><span class="co">#&gt;  extent      : 349884.5, 351675.7, 508614.5, 513074.7  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt;  coord. ref. : OSGB36 / British National Grid (EPSG:27700) </span></span>
<span><span class="co">#&gt;  names       :           name1      identifier       startNode         endNode</span></span>
<span><span class="co">#&gt;  type        :           &lt;chr&gt;           &lt;chr&gt;           &lt;chr&gt;           &lt;chr&gt;</span></span>
<span><span class="co">#&gt;  values      :   Hawthorn Gill 16D0AC09-E0B6-~ 730F01D2-0F4F-~ 72B1A40B-E106-~</span></span>
<span><span class="co">#&gt;                Little Mosedal~ 643017BB-01BC-~ 9B06188C-F4C7-~ A19E0D3A-2FA1-~</span></span>
<span><span class="co">#&gt;                  Mosedale Beck D2C2703E-A32F-~ B03DB3BD-0E33-~ D649B60C-E631-~</span></span>
<span><span class="co">#&gt;         form         flow fictitious length name2 sinkdepth Shape_Leng</span></span>
<span><span class="co">#&gt;        &lt;chr&gt;        &lt;chr&gt;      &lt;chr&gt;  &lt;int&gt; &lt;chr&gt;     &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt;  inlandRiver in direction      false    431    NA        -1      431.3</span></span>
<span><span class="co">#&gt;  inlandRiver in direction      false    513    NA        -1      513.1</span></span>
<span><span class="co">#&gt;  inlandRiver in direction      false    740    NA        -1      739.8</span></span></code></pre></div>
<p>Some of the main properties are present under appropriate names
(startNode, endNode, length) but the remainder are missing. Also the
river network is defined as a series of lines, rather then polygons. The
<code>convert_channel</code> function addresses these shortcomings by -
changing the names of the required properties - buffering the line
objects to create polygons</p>
<p>The <code>convert_channel</code> function takes a named vector giving
the variable names to be use for the properties. If we want to carry
over the identifier as the name we could call
<code>convert_channel</code> with as follows:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">property_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">"name1"</span>,</span>
<span>                    endNode<span class="op">=</span><span class="st">"endNode"</span>,</span>
<span>                    startNode<span class="op">=</span><span class="st">"startNode"</span>,</span>
<span>                    length<span class="op">=</span><span class="st">"length"</span><span class="op">)</span></span>
<span><span class="va">chn</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/convert_channel.html">convert_channel</a></span><span class="op">(</span><span class="va">sp_lines</span>,<span class="va">property_names</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in convert_channel(sp_lines, property_names): Modifying to spatial</span></span>
<span><span class="co">#&gt; polygons using default width</span></span>
<span><span class="co">#&gt; Warning in convert_channel(sp_lines, property_names): Adding default slope</span></span></code></pre></div>
<p>Since the data set for Swindale does not contain a channel width or
slope default values are used and warnings issued.</p>
<p>The river network can then be added to the project by</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctch</span><span class="op">$</span><span class="fu">add_channel</span><span class="op">(</span><span class="va">chn</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="getting-and-plotting-catchment-information">Getting and plotting catchment information<a class="anchor" aria-label="anchor" href="#getting-and-plotting-catchment-information"></a>
</h2>
<p>The <code>dynatopGIS</code> class has methods for returning and
plotting the GIS data in the project. The names of all the different GIS
layers stored is returned by</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctch</span><span class="op">$</span><span class="fu">get_layer</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;          layer                                          source</span></span>
<span><span class="co">#&gt; 1    catchment /tmp/RtmpYJ5ZBV/dygis1c2a3f5734d8/catchment.tif</span></span>
<span><span class="co">#&gt; 2          dem       /tmp/RtmpYJ5ZBV/dygis1c2a3f5734d8/dem.tif</span></span>
<span><span class="co">#&gt; 3      channel   /tmp/RtmpYJ5ZBV/dygis1c2a3f5734d8/channel.tif</span></span>
<span><span class="co">#&gt; 4 channel_vect   /tmp/RtmpYJ5ZBV/dygis1c2a3f5734d8/channel.shp</span></span></code></pre></div>
<p>These can be plotted (with or without the channel), for example</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctch</span><span class="op">$</span><span class="fu">plot_layer</span><span class="op">(</span><span class="st">"dem"</span>, add_channel<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="dynatopGIS_files/figure-html/plot-1.png" width="700"></p>
<p>or returned, for example</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctch</span><span class="op">$</span><span class="fu">get_layer</span><span class="op">(</span><span class="st">"dem"</span><span class="op">)</span></span>
<span><span class="co">#&gt; class       : SpatRaster </span></span>
<span><span class="co">#&gt; dimensions  : 163, 124, 1  (nrow, ncol, nlyr)</span></span>
<span><span class="co">#&gt; resolution  : 40, 40  (x, y)</span></span>
<span><span class="co">#&gt; extent      : 347734, 352694, 507244, 513764  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; coord. ref. : +proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +units=m +no_defs </span></span>
<span><span class="co">#&gt; source      : dem.tif </span></span>
<span><span class="co">#&gt; name        :      dem </span></span>
<span><span class="co">#&gt; min value   : 262.8004 </span></span>
<span><span class="co">#&gt; max value   : 710.7533</span></span></code></pre></div>
<p>All layers are returned as <code>SpatRast</code> objects with the
exception of the <code>channel_vect</code> layer which is returned as a
<code>SpatVect</code> object.</p>
</div>
<div class="section level2">
<h2 id="filling-sinks">Filling sinks<a class="anchor" aria-label="anchor" href="#filling-sinks"></a>
</h2>
<p>For the hill slope to be connected to the river network all DEM cells
must drain to those that intersect with the river network. The algorithm
implemented in the <code>sink_fill</code> method ensures this is the
case. In calling the <code>sink_fill</code> method a flow direction
algorithm is specified and the resulting flow paths recorded. If
subcatchments are present in the catchment map then only flow paths
within the subcatchment are considered.</p>
<p>The algorithm of used by the <code>sink_fill</code> method is
iterative and the execution time of the function is limited by capping
the maximum number of iterations. If this limit is reached without
completion the method can call again with the “hot start” option to
continue from where it finished.</p>
<p>For Swindale, where the example DEM is already partially filled the
algorithm only alters a small area near the foot of the catchment.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctch</span><span class="op">$</span><span class="fu">sink_fill</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span> <span class="va">ctch</span><span class="op">$</span><span class="fu">get_layer</span><span class="op">(</span><span class="st">'filled_dem'</span><span class="op">)</span> <span class="op">-</span> <span class="va">ctch</span><span class="op">$</span><span class="fu">get_layer</span><span class="op">(</span><span class="st">'dem'</span><span class="op">)</span>,</span>
<span>            main<span class="op">=</span><span class="st">"Changes to height"</span><span class="op">)</span></span></code></pre></div>
<p><img src="dynatopGIS_files/figure-html/sink_fill-1.png" width="700"></p>
<div class="section level3">
<h3 id="determining-ordering">Determining Ordering<a class="anchor" aria-label="anchor" href="#determining-ordering"></a>
</h3>
<p>The computational scheme in the <code>dynatop</code> package works
with an ordered sequence of HRUs constructed such that the sequence
moves downslope to catchment outlet. This is achieved by banding the
channel reaches and hillslope cells such that the catchment outlet(s)
are in band 1, those cells or reaches draining only into band 1 are in
band 2 and so forth. banding is achieved by the following call</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctch</span><span class="op">$</span><span class="fu">compute_band</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">ctch</span><span class="op">$</span><span class="fu">plot_layer</span><span class="op">(</span><span class="st">"band"</span><span class="op">)</span></span></code></pre></div>
<p><img src="dynatopGIS_files/figure-html/band-1.png" width="700"></p>
</div>
</div>
<div class="section level2">
<h2 id="computing-properties">Computing properties<a class="anchor" aria-label="anchor" href="#computing-properties"></a>
</h2>
<p>Two sets of properties are required for Dynamic TOPMODEL. The first
set is those required within the evaluation of the model; gradient and
contour length. The second set are those used for dividing the catchment
up into Hydrological Response Units (HRUs). Traditionally the summary
used for the separation of the HRUs is the topographic index, which is
the natural logarithm of the upslope area divided by gradient.</p>
<p>These are computed using the formulae in <a href="https://doi.org/10.1002/hyp.3360050106" class="external-link">Quinn et al. 1991</a>.</p>
<p>The upstream area is computed by routing down slope with the fraction
of the area being routed to the next downstream pixel being proportional
to the gradient times the contour length.</p>
<p>The local value of the gradient is computed using the average of a
subset of between pixel gradients. For a normal ‘hill slope’ cell these
are the gradients to downslope pixels weighted by contour length. In the
case of pixels which contain river channels the average of the gradients
from upslope pixels weighted by contour length us used.</p>
<p>These properties are computed in an algorithm that passes over the
data once in descending height. It is called as follows</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctch</span><span class="op">$</span><span class="fu">compute_properties</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>The plot of the topographic index shows a pattern of increasing
values closer to the river channels</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## plot of topographic index (log(a/tan b))</span></span>
<span><span class="va">ctch</span><span class="op">$</span><span class="fu">plot_layer</span><span class="op">(</span><span class="st">'atb'</span><span class="op">)</span></span></code></pre></div>
<p><img src="dynatopGIS_files/figure-html/plot_atb-1.png" width="700"></p>
<p>Although not used in ordering the HRUs <code>dynatopGIS</code> also
provides the ability to compute flow distances for the hill slope cells.
The calculation of three distances is supported</p>
<ul>
<li>
<em>shortest flow length</em> - the shortest length based on the
pixel flow paths to a channel</li>
<li>
<em>Dominant flow length</em> - the distance to a channel moving in
the dominant (largest fraction) flow direction from any grid cell</li>
<li>
<em>Expected flow length</em> - the distance to the channel based on
a weighted average of the down-slope flow lengths. Weights are given by
the fraction of flow in each direction.</li>
</ul>
<p>The computation, in this example for the shortest flow length, is
initiated with</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctch</span><span class="op">$</span><span class="fu">compute_flow_lengths</span><span class="op">(</span>flow_routing<span class="op">=</span><span class="st">"shortest"</span><span class="op">)</span></span></code></pre></div>
<p>The additional layers can be examined as expected</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctch</span><span class="op">$</span><span class="fu">get_layer</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;                   layer</span></span>
<span><span class="co">#&gt; 1             catchment</span></span>
<span><span class="co">#&gt; 2                   dem</span></span>
<span><span class="co">#&gt; 3               channel</span></span>
<span><span class="co">#&gt; 4            filled_dem</span></span>
<span><span class="co">#&gt; 5                  band</span></span>
<span><span class="co">#&gt; 6              gradient</span></span>
<span><span class="co">#&gt; 7          upslope_area</span></span>
<span><span class="co">#&gt; 8                   atb</span></span>
<span><span class="co">#&gt; 9  shortest_flow_length</span></span>
<span><span class="co">#&gt; 10         channel_vect</span></span>
<span><span class="co">#&gt;                                                        source</span></span>
<span><span class="co">#&gt; 1             /tmp/RtmpYJ5ZBV/dygis1c2a3f5734d8/catchment.tif</span></span>
<span><span class="co">#&gt; 2                   /tmp/RtmpYJ5ZBV/dygis1c2a3f5734d8/dem.tif</span></span>
<span><span class="co">#&gt; 3               /tmp/RtmpYJ5ZBV/dygis1c2a3f5734d8/channel.tif</span></span>
<span><span class="co">#&gt; 4            /tmp/RtmpYJ5ZBV/dygis1c2a3f5734d8/filled_dem.tif</span></span>
<span><span class="co">#&gt; 5                  /tmp/RtmpYJ5ZBV/dygis1c2a3f5734d8/band.tif</span></span>
<span><span class="co">#&gt; 6              /tmp/RtmpYJ5ZBV/dygis1c2a3f5734d8/gradient.tif</span></span>
<span><span class="co">#&gt; 7          /tmp/RtmpYJ5ZBV/dygis1c2a3f5734d8/upslope_area.tif</span></span>
<span><span class="co">#&gt; 8                   /tmp/RtmpYJ5ZBV/dygis1c2a3f5734d8/atb.tif</span></span>
<span><span class="co">#&gt; 9  /tmp/RtmpYJ5ZBV/dygis1c2a3f5734d8/shortest_flow_length.tif</span></span>
<span><span class="co">#&gt; 10              /tmp/RtmpYJ5ZBV/dygis1c2a3f5734d8/channel.shp</span></span>
<span><span class="va">ctch</span><span class="op">$</span><span class="fu">plot_layer</span><span class="op">(</span><span class="st">"shortest_flow_length"</span><span class="op">)</span></span></code></pre></div>
<p><img src="dynatopGIS_files/figure-html/flow_length_plot-1.png" width="700"></p>
<div class="section level3">
<h3 id="adding-additional-layer">Adding additional layer<a class="anchor" aria-label="anchor" href="#adding-additional-layer"></a>
</h3>
<p>Properties may come in additional GIS layers. To demonstrate the
addition of an additional layer we will extract the filled dem</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="va">ctch</span><span class="op">$</span><span class="fu">get_layer</span><span class="op">(</span><span class="st">"filled_dem"</span><span class="op">)</span></span></code></pre></div>
<p>then separate it into a layers representing land above and below
500m.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## T</span></span>
<span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/ifelse.html" class="external-link">ifel</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">&lt;=</span><span class="fl">500</span>,<span class="cn">NA</span>,<span class="op">-</span><span class="fl">999</span><span class="op">)</span></span></code></pre></div>
<p>The resulting raster object can now be added to the project with</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctch</span><span class="op">$</span><span class="fu">add_layer</span><span class="op">(</span><span class="va">tmp</span>, <span class="st">"greater_500"</span><span class="op">)</span></span>
<span><span class="va">ctch</span><span class="op">$</span><span class="fu">get_layer</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;                   layer</span></span>
<span><span class="co">#&gt; 1             catchment</span></span>
<span><span class="co">#&gt; 2                   dem</span></span>
<span><span class="co">#&gt; 3               channel</span></span>
<span><span class="co">#&gt; 4            filled_dem</span></span>
<span><span class="co">#&gt; 5                  band</span></span>
<span><span class="co">#&gt; 6              gradient</span></span>
<span><span class="co">#&gt; 7          upslope_area</span></span>
<span><span class="co">#&gt; 8                   atb</span></span>
<span><span class="co">#&gt; 9  shortest_flow_length</span></span>
<span><span class="co">#&gt; 10          greater_500</span></span>
<span><span class="co">#&gt; 11         channel_vect</span></span>
<span><span class="co">#&gt;                                                        source</span></span>
<span><span class="co">#&gt; 1             /tmp/RtmpYJ5ZBV/dygis1c2a3f5734d8/catchment.tif</span></span>
<span><span class="co">#&gt; 2                   /tmp/RtmpYJ5ZBV/dygis1c2a3f5734d8/dem.tif</span></span>
<span><span class="co">#&gt; 3               /tmp/RtmpYJ5ZBV/dygis1c2a3f5734d8/channel.tif</span></span>
<span><span class="co">#&gt; 4            /tmp/RtmpYJ5ZBV/dygis1c2a3f5734d8/filled_dem.tif</span></span>
<span><span class="co">#&gt; 5                  /tmp/RtmpYJ5ZBV/dygis1c2a3f5734d8/band.tif</span></span>
<span><span class="co">#&gt; 6              /tmp/RtmpYJ5ZBV/dygis1c2a3f5734d8/gradient.tif</span></span>
<span><span class="co">#&gt; 7          /tmp/RtmpYJ5ZBV/dygis1c2a3f5734d8/upslope_area.tif</span></span>
<span><span class="co">#&gt; 8                   /tmp/RtmpYJ5ZBV/dygis1c2a3f5734d8/atb.tif</span></span>
<span><span class="co">#&gt; 9  /tmp/RtmpYJ5ZBV/dygis1c2a3f5734d8/shortest_flow_length.tif</span></span>
<span><span class="co">#&gt; 10          /tmp/RtmpYJ5ZBV/dygis1c2a3f5734d8/greater_500.tif</span></span>
<span><span class="co">#&gt; 11              /tmp/RtmpYJ5ZBV/dygis1c2a3f5734d8/channel.shp</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="classifying-into-hydrological-response-units">Classifying into Hydrological Response Units<a class="anchor" aria-label="anchor" href="#classifying-into-hydrological-response-units"></a>
</h2>
<p>Methods are provided for the classification of the catchment areas of
similar hydrological response. The classifications generated in this
process are augmented with a further distance based separation when
generating a <code>dynatop</code> model (see following section).</p>
<p>By definition each channel length is treated as belonging to a single
class.</p>
<p>To classify the hillslope two methods can be used.</p>
<p>The <code>classify</code> method of a <code>dynatopGIS</code> allows
a landscape property to be <em>cut</em> into classes.</p>
<p>For example to cut the topographic index for Swindale into 21
classes:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctch</span><span class="op">$</span><span class="fu">classify</span><span class="op">(</span><span class="st">"atb_20"</span>,<span class="st">"atb"</span>,cuts<span class="op">=</span><span class="fl">20</span><span class="op">)</span></span>
<span><span class="va">ctch</span><span class="op">$</span><span class="fu">plot_layer</span><span class="op">(</span><span class="st">"atb_20"</span><span class="op">)</span></span></code></pre></div>
<p><img src="dynatopGIS_files/figure-html/atb_split-1.png" width="700"></p>
<p>Providing a single value to the cuts argument determines the number
of classes. The values used to cut the variable can be extracted from
the meta data with</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctch</span><span class="op">$</span><span class="fu">get_method</span><span class="op">(</span><span class="st">"atb_20"</span><span class="op">)</span></span>
<span><span class="co">#&gt; $type</span></span>
<span><span class="co">#&gt; [1] "classification"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $layer</span></span>
<span><span class="co">#&gt; [1] "atb"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $cuts</span></span>
<span><span class="co">#&gt;  [1]  8.6361  9.2646  9.8931 10.5217 11.1502 11.7787 12.4072 13.0357 13.6642</span></span>
<span><span class="co">#&gt; [10] 14.2927 14.9212 15.5498 16.1783 16.8068 17.4353 18.0638 18.6923 19.3208</span></span>
<span><span class="co">#&gt; [19] 19.9493 20.5779 21.2064</span></span></code></pre></div>
<p>The <code>combine_classes</code> method of a <code>dynatopGIS</code>
allows classes to be combined in two ways, which are applied in the
order shown</p>
<ul>
<li>
<em>pairing</em> - where unique combinations of classes create one
new class</li>
<li>
<em>burning</em> - where a single class is imposed upon an area</li>
</ul>
<p>To demonstrate a pairing combination consider combining the atb
classes generated above with the classification provided by the distance
band</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctch</span><span class="op">$</span><span class="fu">combine_classes</span><span class="op">(</span><span class="st">"atb_20_band"</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"atb_20"</span>,<span class="st">"band"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ctch</span><span class="op">$</span><span class="fu">plot_layer</span><span class="op">(</span><span class="st">"atb_20_band"</span><span class="op">)</span></span></code></pre></div>
<p><img src="dynatopGIS_files/figure-html/atb_20_band-1.png" width="700"></p>
<p>Additionally the land greater then 500 in altitude can be burnt in
with</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctch</span><span class="op">$</span><span class="fu">combine_classes</span><span class="op">(</span><span class="st">"atb_20_band_500"</span>,pairs<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"atb_20"</span>,<span class="st">"band"</span><span class="op">)</span>,burns<span class="op">=</span><span class="st">"greater_500"</span><span class="op">)</span></span>
<span><span class="va">ctch</span><span class="op">$</span><span class="fu">plot_layer</span><span class="op">(</span><span class="st">"atb_20_band_500"</span><span class="op">)</span></span></code></pre></div>
<p><img src="dynatopGIS_files/figure-html/atb_20_band_burn-1.png" width="700"></p>
<p>The each class in the combined classification the values of the
classes used in the computations can be returned</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span> <span class="va">ctch</span><span class="op">$</span><span class="fu">get_method</span><span class="op">(</span><span class="st">"atb_20_band_500"</span><span class="op">)</span><span class="op">$</span><span class="va">groups</span> <span class="op">)</span></span>
<span><span class="co">#&gt;   atb_20_band_500 atb_20 band burns</span></span>
<span><span class="co">#&gt; 1               1      4  194  TRUE</span></span>
<span><span class="co">#&gt; 2               2      5    3 FALSE</span></span>
<span><span class="co">#&gt; 3               3      7    2 FALSE</span></span>
<span><span class="co">#&gt; 4               4      6    3 FALSE</span></span>
<span><span class="co">#&gt; 5               5      7    3 FALSE</span></span>
<span><span class="co">#&gt; 6               6      6    4 FALSE</span></span></code></pre></div>
<p>Note that by giving the area to be burnt in a negative value when it
was generated above we have ensured that the values do not clash with
those generated by the cuts which (except potentially when a cut is NA)
which will always be positive.</p>
</div>
<div class="section level2">
<h2 id="generating-a-dynamic-topmodel">Generating a dynamic TOPMODEL<a class="anchor" aria-label="anchor" href="#generating-a-dynamic-topmodel"></a>
</h2>
<p>A Dynamic TOPMODEL suitable for use with the <code>dynatop</code>
package can be generated using the <code>create_model</code> method.
This uses an existing classification to generate the model. The required
model structure is given in the vignettes of <code>dynatop</code>
package and is not described here in details.</p>
<p>Since <code>dynatop</code> simulations make use of ordered HRUs to
work downslope, a classification which used a distance layer (see
earlier section) which represents the ordered downslope sequencing of
the pixels is recommended.</p>
<p>Even if a distance layer is not used in the classification one must
be given to the <code>create_model</code> method, so the resulting HRUs
can be ordered.</p>
<p><strong>Currently only the ‘band’ distance metric as used below will
produce valid model</strong>.</p>
<p>For example, in the case of the division of Swindale by topographic
index into 21 classes and the bands directly the resulting model can be
generated by</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctch</span><span class="op">$</span><span class="fu">create_model</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">demo_dir</span>,<span class="st">"new_model"</span><span class="op">)</span>,<span class="st">"atb_20"</span><span class="op">)</span></span></code></pre></div>
<p>Looking at the files within the <code>demo_dir</code> folder</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">demo_dir</span>,pattern<span class="op">=</span><span class="st">"new_model*"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "new_model.rds" "new_model.tif"</span></span></code></pre></div>
<p>shows that an addition raster map of the HRUs has been created in
<code>new_model.tif</code> along with a file <code>new_model.rds</code>
containing a model suitable for <code>dynatop</code>. The values on the
map correspond to the <code>ìd</code> of the HRUs in the
<code>dynatop</code> model.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Paul Smith.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
