<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Filling sinks and gaps in the DEM • dynatopGIS</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Filling sinks and gaps in the DEM">
<meta property="og:description" content="dynatopGIS">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">dynatopGIS</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.0.9020</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/dynatopGIS.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Banding.html">Banding of HSUs</a>
    </li>
    <li>
      <a href="../articles/sink_filling.html">Filling sinks and gaps in the DEM</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/waternumbers/dynatopGIS/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Filling sinks and gaps in the DEM</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/waternumbers/dynatopGIS/blob/master/vignettes/sink_filling.Rmd"><code>vignettes/sink_filling.Rmd</code></a></small>
      <div class="hidden name"><code>sink_filling.Rmd</code></div>

    </div>

    
    
<pre><code>#&gt; Loading required package: sp</code></pre>
<p>The purpose of this vignette is to outline the sink filling routine used by the <code>sink_fill</code> function and provide some simple demonstrations.</p>
<p>The routine used is deliberately simple, doing the minimum required to populate sinks and missing data to produce valid flow directions. More complex routines can by found in many GIS packages and published work.</p>
<div id="algorithm" class="section level1">
<h1 class="hasAnchor">
<a href="#algorithm" class="anchor"></a>Algorithm</h1>
<p>In the following we take <span class="math inline">\(z_{k}\)</span> to be the height of the dem at cell <span class="math inline">\(k\)</span>, <span class="math inline">\(\mathcal{N}_{k}\)</span> to be the set of index values for the neighbouring points in space with non-missing (i.e not <code>NA</code> or <code>NaN</code> in R) height values and <span class="math inline">\(\hat{\mathcal{N}}_{k}\)</span> teh set of index values for neighbouring points with finite heights.</p>
<div id="identifying-data-requiring-replacement" class="section level2">
<h2 class="hasAnchor">
<a href="#identifying-data-requiring-replacement" class="anchor"></a>Identifying data requiring replacement</h2>
<div id="determining-missing-data-in-the-dem" class="section level3">
<h3 class="hasAnchor">
<a href="#determining-missing-data-in-the-dem" class="anchor"></a>Determining missing data in the DEM</h3>
<p>To determine which data are missing non-finite values not associated witht he edge of the DEM are identified. This is done by</p>
<ol style="list-style-type: decimal">
<li>Replacing all non-finite values in the dem with <code>NA</code>
</li>
<li>Creating clumps (see <code><a href="https://rdrr.io/pkg/raster/man/clump.html">raster::clump</a></code>) of all <code>NA</code> cell values</li>
<li>Taking all clumps that do not touch the extent of the raster DEM to be missing data.</li>
</ol>
<p>Cells with missing data are assigned a value of <code>-Inf</code> (<span class="math inline">\(-\infty\)</span>). Initialise a set <span class="math inline">\(\mathcal{S}\)</span> of the locations where the DEM value needs replacement with the location of the <code>-Inf</code> values. The locations are stored a single numerical index of the DEM cell.</p>
</div>
<div id="determining-sinks-within-the-dem" class="section level3">
<h3 class="hasAnchor">
<a href="#determining-sinks-within-the-dem" class="anchor"></a>Determining sinks within the DEM</h3>
<p>A sink is any pixel in the DEM for which <span class="math inline">\(z_{k} \leq \min_{j \in \mathcal{N}_k} \left(z_{j}\right)\)</span>. A pass through the DEM can be used to identify sinks. Where a sink is identified set <span class="math inline">\(z_{k}\)</span> to <code>-Inf</code> (<span class="math inline">\(-\infty\)</span>), add <span class="math inline">\(k\)</span> to <span class="math inline">\(\mathcal{S}\)</span> and check the neighbouring cells to ensure they are not now sinks.</p>
</div>
</div>
<div id="replacing-values" class="section level2">
<h2 class="hasAnchor">
<a href="#replacing-values" class="anchor"></a>Replacing values</h2>
<p>Replacing the unknown values from the ‘lowest’ up would ensure all could be relaced by a single pass through the points in <span class="math inline">\(\mathcal{R}\)</span>. However since the values are not known this not possible. Instead we approximate this by:</p>
<ol style="list-style-type: decimal">
<li>For each <span class="math inline">\(k \in \mathcal{R}\)</span> compute <span class="math inline">\(m_k = \min_{j \in \hat{\mathcal{N}}_k} \left(z_{j}\right)\)</span>
</li>
<li>Take <span class="math inline">\(\tilde{k}\)</span> and value of <span class="math inline">\(k\)</span> for which <span class="math inline">\(m_k\)</span> is at a minimum.</li>
<li>Set <span class="math inline">\(z_k = \mean_{j \in \hat{\mathcal{N}}_k} \left(z_{j}\right)\)</span>
</li>
<li>Remove <span class="math inline">\(k\)</span> from <span class="math inline">\(\mathcal{R}\)</span> and return to step 1</li>
</ol>
<p>Note that the replacement rule in step 3 ensure that no new sinks are generated.</p>
<p>. New dem values are computed as the mean of the adjoining finite cell values. New minimums for the adjacent cells are then computed before resorting the sinks and moving on.</p>
</div>
</div>
<div id="examples" class="section level1">
<h1 class="hasAnchor">
<a href="#examples" class="anchor"></a>Examples</h1>
<p>Example dates is generated randomly</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">M</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">100</span>,<span class="fl">10</span>,<span class="fl">10</span><span class="op">)</span>
<span class="va">dem</span> <span class="op">&lt;-</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/raster.html">raster</a></span><span class="op">(</span><span class="va">M</span>,
                      crs<span class="op">=</span><span class="st">"+init=epsg:27700"</span><span class="op">)</span> <span class="co"># UK OS projection</span>
<span class="va">chn</span> <span class="op">&lt;-</span> <span class="fu">rasterToPolygons</span><span class="op">(</span><span class="va">dem</span>,<span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="va">x</span><span class="op">==</span><span class="fl">1</span><span class="op">}</span><span class="op">)</span>
<span class="va">chn</span><span class="op">$</span><span class="va">length</span> <span class="op">&lt;-</span> <span class="fl">10</span>
<span class="va">chn</span><span class="op">$</span><span class="va">startNode</span> <span class="op">&lt;-</span> <span class="st">"node1"</span>
<span class="va">chn</span><span class="op">$</span><span class="va">endNode</span> <span class="op">&lt;-</span> <span class="st">"node2"</span>
<span class="va">chn</span><span class="op">$</span><span class="va">width</span> <span class="op">&lt;-</span> <span class="fl">0.001</span></code></pre></div>
<div id="handling-of-a-larger-area-of-missing" class="section level2">
<h2 class="hasAnchor">
<a href="#handling-of-a-larger-area-of-missing" class="anchor"></a>handling of a larger area of missing</h2>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ex1_dem</span> <span class="op">&lt;-</span> <span class="va">dem</span>
<span class="va">ex1_dem</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">23</span><span class="op">:</span><span class="fl">26</span>,<span class="fl">33</span><span class="op">:</span><span class="fl">36</span>,<span class="fl">44</span><span class="op">:</span><span class="fl">45</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span>

<span class="va">ex1_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span><span class="op">(</span><span class="st">"ex1"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span><span class="op">(</span><span class="va">ex1_dir</span><span class="op">)</span>
<span class="va">ex1</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/dynatopGIS.html">dynatopGIS</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">ex1_dir</span>,<span class="st">"meta.json"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Warning in initialize(...): Creating meta file at/tmp/Rtmp4mOKCh/</span>
<span class="co">#&gt; ex149ba2d7a17a5/meta.json</span>
<span class="co">#&gt; Warning in private$check_meta(verbose): No checks on the meta are currently</span>
<span class="co">#&gt; performed</span>
<span class="va">ex1</span><span class="op">$</span><span class="fu">add_dem</span><span class="op">(</span><span class="va">ex1_dem</span><span class="op">)</span>
<span class="co">#&gt; Loading required namespace: igraph</span>
<span class="va">ex1</span><span class="op">$</span><span class="fu">add_channel</span><span class="op">(</span><span class="va">chn</span><span class="op">)</span>
<span class="va">ex1</span><span class="op">$</span><span class="fu">compute_areas</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Warning in .local(x, ...): This function is only useful for Raster* objects with</span>
<span class="co">#&gt; a longitude/latitude coordinates</span>
<span class="va">ex1</span><span class="op">$</span><span class="fu">sink_fill</span><span class="op">(</span><span class="op">)</span>
<span class="va">ex1</span><span class="op">$</span><span class="fu">plot_layer</span><span class="op">(</span><span class="st">"dem"</span>,<span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p><img src="sink_filling_files/figure-html/example1-1.png" width="700"></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ex1</span><span class="op">$</span><span class="fu">plot_layer</span><span class="op">(</span><span class="st">"filled_dem"</span>,<span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p><img src="sink_filling_files/figure-html/example1-2.png" width="700"></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/unlink.html">unlink</a></span><span class="op">(</span><span class="va">ex1_dir</span>, recursive<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
</div>
<div id="handling-of-a-single-island" class="section level2">
<h2 class="hasAnchor">
<a href="#handling-of-a-single-island" class="anchor"></a>handling of a single island</h2>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ex2_dem</span> <span class="op">&lt;-</span> <span class="va">dem</span>
<span class="va">ex2_dem</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">23</span><span class="op">:</span><span class="fl">26</span>,<span class="fl">33</span><span class="op">:</span><span class="fl">36</span>,<span class="fl">44</span><span class="op">:</span><span class="fl">45</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span>
<span class="va">ex2_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span><span class="op">(</span><span class="st">"ex2"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span><span class="op">(</span><span class="va">ex2_dir</span><span class="op">)</span>
<span class="va">ex2</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/dynatopGIS.html">dynatopGIS</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">ex2_dir</span>,<span class="st">"meta.json"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Warning in initialize(...): Creating meta file at/tmp/Rtmp4mOKCh/</span>
<span class="co">#&gt; ex249ba679945b2/meta.json</span>
<span class="co">#&gt; Warning in private$check_meta(verbose): No checks on the meta are currently</span>
<span class="co">#&gt; performed</span>
<span class="va">ex2</span><span class="op">$</span><span class="fu">add_dem</span><span class="op">(</span><span class="va">ex2_dem</span><span class="op">)</span>
<span class="va">ex2</span><span class="op">$</span><span class="fu">add_channel</span><span class="op">(</span><span class="va">chn</span><span class="op">)</span>
<span class="va">ex2</span><span class="op">$</span><span class="fu">compute_areas</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Warning in .local(x, ...): This function is only useful for Raster* objects with</span>
<span class="co">#&gt; a longitude/latitude coordinates</span>
<span class="va">ex2</span><span class="op">$</span><span class="fu">sink_fill</span><span class="op">(</span><span class="op">)</span>
<span class="va">ex2</span><span class="op">$</span><span class="fu">plot_layer</span><span class="op">(</span><span class="st">"dem"</span>,<span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p><img src="sink_filling_files/figure-html/example2-1.png" width="700"></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ex2</span><span class="op">$</span><span class="fu">plot_layer</span><span class="op">(</span><span class="st">"filled_dem"</span>,<span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p><img src="sink_filling_files/figure-html/example2-2.png" width="700"></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/unlink.html">unlink</a></span><span class="op">(</span><span class="va">ex2_dir</span>, recursive<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Paul Smith.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
