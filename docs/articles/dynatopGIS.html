<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Building a Dynamic TOPMODEL • dynatopGIS</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Building a Dynamic TOPMODEL">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">dynatopGIS</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.8</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/dynatopGIS.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/waternumbers/dynatopGIS">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Building a Dynamic TOPMODEL</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/waternumbers/dynatopGIS/blob/master/../vignettes/dynatopGIS.Rmd"><code>../vignettes/dynatopGIS.Rmd</code></a></small>
      <div class="hidden name"><code>dynatopGIS.Rmd</code></div>

    </div>

    
    
<p>The purpose of this vignette is to provide an outline of the steps needed to build a dynamic TOPMODEL implementation using the dynatopGIS package.</p>
<div id="principles-behind-dynatopgis" class="section level1">
<h1 class="hasAnchor">
<a href="#principles-behind-dynatopgis" class="anchor"></a>Principles behind dynatopGIS</h1>
<p>The dynatopGIS package is designed to work with a structured data flow, where by GIS data are processed through intermediate stages until one or more dynamic TOPMODEL implementations are produced. The processed GIS data are stored within two objects; a rasterBrick and a SpatialPolygonsDataFrame.</p>
<p>At any point in the analysis the these two objects can be written to disk and reloaded using the commands within the <code>raster</code> package. There is no formal linkage between the rasterBrick and SpatialPolygonsDataFrame object so spurious models may be produced if incorrect file combinations are used. Creating a document such as this vignette which documents the work flow used should significantly enhance the chances of ensuring the work is reproducible.</p>
</div>
<div id="getting-started" class="section level1">
<h1 class="hasAnchor">
<a href="#getting-started" class="anchor"></a>Getting started</h1>
<p>The basis of the analysis are a rasterised Digital Elevation Model (DEM) of the catchment and a vectorised representation of the river network with attributes. Current these can be in any format supported by the <code>raster</code> and <code>sp</code> libraries respectivly.</p>
<p>However within the calculations used for sink filling, flow routing and topographic index calculations the raster DEM is presumed to be projected so that is has square or rectangular cells such that the difference between the cells centers (in meters) does not alter.</p>
<div id="swindale" class="section level2">
<h2 class="hasAnchor">
<a href="#swindale" class="anchor"></a>Swindale</h2>
<p>The use of the dynatopGIS package is demonstrated using data from the Swindale catchment in the UK. This is included in the external data directory of the package with the following file paths.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(dynatopGIS)</a>
<a class="sourceLine" id="cb1-2" title="2">dem_file &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/system.file">system.file</a></span>(<span class="st">"extdata"</span>, <span class="st">"SwindaleDTM4mFilled.tif"</span>, <span class="dt">package=</span><span class="st">"dynatopGIS"</span>)</a>
<a class="sourceLine" id="cb1-3" title="3">channel_file &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/system.file">system.file</a></span>(<span class="st">"extdata"</span>, <span class="st">"SwindaleRiverNetwork.shp"</span>, <span class="dt">package=</span><span class="st">"dynatopGIS"</span>)</a></code></pre></div>
<!-- ```{r, include = FALSE} -->
<!-- ## this stops the code evaluating on CRAN -->
<!-- knitr::opts_chunk$set(eval = file.exists(file.path(initial_path,"SwindaleDTM4mFilled.tif")) -->
<!-- ) -->
<!-- ``` -->
</div>
</div>
<div id="initialising-the-gis-objects" class="section level1">
<h1 class="hasAnchor">
<a href="#initialising-the-gis-objects" class="anchor"></a>Initialising the GIS objects</h1>
<p>The package contains functions to correctly initialise the GIS objects populated during the analysis.</p>
<p>In the case of the rasterBrick the initialisation function takes the DEM (either as a rasterLayer or file name). The brick in initialised by calling <code>create_brick</code> as follow</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1">brck &lt;-<span class="st"> </span><span class="kw"><a href="../reference/gis_brick.html">create_brick</a></span>(dem_file)</a>
<a class="sourceLine" id="cb2-2" title="2"><span class="co">#&gt; Loading required namespace: igraph</span></a></code></pre></div>
<p>The returned rasterBrick a number of layers</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(brck)</a>
<a class="sourceLine" id="cb3-2" title="2"><span class="co">#&gt;  [1] "dem"            "filled_dem"     "land_area"      "channel_area"  </span></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="co">#&gt;  [5] "channel_id"     "atanb"          "gradient"       "upslope_area"  </span></a>
<a class="sourceLine" id="cb3-4" title="4"><span class="co">#&gt;  [9] "contour_length" "order"</span></a></code></pre></div>
<p>which are populated in the following steps. Project information is taken from the DEM.</p>
<p>and return for reading the DEM and river network. These read in the specified files and outputs them to the project directory in a standard format. For the DEM this is straight forward</p>
<p>Reading the river channel data data is more complex. Each vector object in the GIS file of channel information is treated as a length of river reach and requires the following properties</p>
<ul>
<li>
<em>endNode</em> - a label for the downstream end of the river length</li>
<li>
<em>startNode</em> - a label for the upstream end of the river length</li>
<li>
<em>length</em> - the length in meters</li>
</ul>
<p>Additional proporties are currently ignored with two exceptions: - <em>id</em> - this is overwrittem with a warning and used internally - <em>width</em> - if the channel is specified a line sections then the <em>width</em> property is used to buffer the lines to create channle polygons.</p>
<p>Since it is possible that these properties are present in the current data but under different names the <code>create_channel</code> function allows for renaming. To illustrate this let us examine the river network for Swindale</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1">shp &lt;-<span class="st"> </span>rgdal<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/rgdal/topics/readOGR">readOGR</a></span>(channel_file)</a>
<a class="sourceLine" id="cb4-2" title="2"><span class="co">#&gt; OGR data source with driver: ESRI Shapefile </span></a>
<a class="sourceLine" id="cb4-3" title="3"><span class="co">#&gt; Source: "/home/paul/R/x86_64-suse-linux-gnu-library/3.6/dynatopGIS/extdata/SwindaleRiverNetwork.shp", layer: "SwindaleRiverNetwork"</span></a>
<a class="sourceLine" id="cb4-4" title="4"><span class="co">#&gt; with 19 features</span></a>
<a class="sourceLine" id="cb4-5" title="5"><span class="co">#&gt; It has 11 fields</span></a>
<a class="sourceLine" id="cb4-6" title="6"><span class="co">#&gt; Integer64 fields read as strings:  length</span></a>
<a class="sourceLine" id="cb4-7" title="7"><span class="co">#&gt; Warning in rgdal::readOGR(channel_file): Z-dimension discarded</span></a>
<a class="sourceLine" id="cb4-8" title="8"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(shp)</a>
<a class="sourceLine" id="cb4-9" title="9"><span class="co">#&gt; class       : SpatialLinesDataFrame </span></a>
<a class="sourceLine" id="cb4-10" title="10"><span class="co">#&gt; features    : 6 </span></a>
<a class="sourceLine" id="cb4-11" title="11"><span class="co">#&gt; extent      : 349884.5, 351675.7, 508614.5, 513074.7  (xmin, xmax, ymin, ymax)</span></a>
<a class="sourceLine" id="cb4-12" title="12"><span class="co">#&gt; crs         : +proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +towgs84=446.448,-125.157,542.06,0.15,0.247,0.842,-20.489 +units=m +no_defs </span></a>
<a class="sourceLine" id="cb4-13" title="13"><span class="co">#&gt; variables   : 11</span></a>
<a class="sourceLine" id="cb4-14" title="14"><span class="co">#&gt; names       :         name1,                           identifier,                            startNode,                              endNode,        form,         flow, fictitious, length, name2, sinkdepth,    Shape_Leng </span></a>
<a class="sourceLine" id="cb4-15" title="15"><span class="co">#&gt; min values  : Hawthorn Gill, 16D0AC09-E0B6-4727-83B8-567E8DE9C533, 1FDBFCFF-799C-41CF-A2CB-8A56368BD438, 1FDBFCFF-799C-41CF-A2CB-8A56368BD438, inlandRiver, in direction,      false,     29,    NA,        -1, 29.1895135281 </span></a>
<a class="sourceLine" id="cb4-16" title="16"><span class="co">#&gt; max values  : Mosedale Beck, ED03FEDD-0F4B-40C7-86E8-6F0EA8BAC182, D968F174-FB80-404A-A4A7-2862CC722482, D649B60C-E631-47FA-971E-CA388DBDDE63, inlandRiver, in direction,      false,    740,    NA,        -1,  739.76377764</span></a></code></pre></div>
<p>The main properties are present under appropriate names and a call to <code>create_channel</code> with no options would be successful. However if we want to carry over the addition information in the “indentifier” as “channel_id” a named vector giving the variable names to be used could be provided. In this case:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1">property_names &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dt">channel_id=</span><span class="st">"identifier"</span>,</a>
<a class="sourceLine" id="cb5-2" title="2">                    <span class="dt">endNode=</span><span class="st">"endNode"</span>,</a>
<a class="sourceLine" id="cb5-3" title="3">                    <span class="dt">startNode=</span><span class="st">"startNode"</span>,</a>
<a class="sourceLine" id="cb5-4" title="4">                    <span class="dt">length=</span><span class="st">"length"</span>)</a></code></pre></div>
<p>Since the data set for Swindale does not contain a channel width we use the default width of 2m in <code>create_channel</code>. The river network can then be created in the correct format by</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1">chn &lt;-<span class="st"> </span><span class="kw"><a href="../reference/create_channel.html">create_channel</a></span>(shp,property_names)</a>
<a class="sourceLine" id="cb6-2" title="2"><span class="co">#&gt; Warning in create_channel(shp, property_names): Modifying to spatial</span></a>
<a class="sourceLine" id="cb6-3" title="3"><span class="co">#&gt; polygons using default width</span></a>
<a class="sourceLine" id="cb6-4" title="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(chn<span class="op">@</span>data)</a>
<a class="sourceLine" id="cb6-5" title="5"><span class="co">#&gt;                             channel_id</span></a>
<a class="sourceLine" id="cb6-6" title="6"><span class="co">#&gt; 0 16D0AC09-E0B6-4727-83B8-567E8DE9C533</span></a>
<a class="sourceLine" id="cb6-7" title="7"><span class="co">#&gt; 1 643017BB-01BC-4738-898F-1C62B84164BF</span></a>
<a class="sourceLine" id="cb6-8" title="8"><span class="co">#&gt; 2 D2C2703E-A32F-4D88-A022-4E27EA52FC5C</span></a>
<a class="sourceLine" id="cb6-9" title="9"><span class="co">#&gt; 3 991D9896-CA0C-492F-A6EE-8BA3972DDA3C</span></a>
<a class="sourceLine" id="cb6-10" title="10"><span class="co">#&gt; 4 CC8639D7-00D2-4C26-9252-350E5A748D51</span></a>
<a class="sourceLine" id="cb6-11" title="11"><span class="co">#&gt; 5 ED03FEDD-0F4B-40C7-86E8-6F0EA8BAC182</span></a>
<a class="sourceLine" id="cb6-12" title="12"><span class="co">#&gt;                                endNode</span></a>
<a class="sourceLine" id="cb6-13" title="13"><span class="co">#&gt; 0 72B1A40B-E106-42A9-A261-4B7720037ADB</span></a>
<a class="sourceLine" id="cb6-14" title="14"><span class="co">#&gt; 1 A19E0D3A-2FA1-4E6D-AEA4-472F91ABC2AC</span></a>
<a class="sourceLine" id="cb6-15" title="15"><span class="co">#&gt; 2 D649B60C-E631-47FA-971E-CA388DBDDE63</span></a>
<a class="sourceLine" id="cb6-16" title="16"><span class="co">#&gt; 3 1FDBFCFF-799C-41CF-A2CB-8A56368BD438</span></a>
<a class="sourceLine" id="cb6-17" title="17"><span class="co">#&gt; 4 7C251581-3764-4DEE-8031-EC98FABC1F87</span></a>
<a class="sourceLine" id="cb6-18" title="18"><span class="co">#&gt; 5 673269DF-9E48-4EA0-B439-3D565A023DD2</span></a>
<a class="sourceLine" id="cb6-19" title="19"><span class="co">#&gt;                              startNode length id width</span></a>
<a class="sourceLine" id="cb6-20" title="20"><span class="co">#&gt; 0 730F01D2-0F4F-4E27-AF55-B1782F0F844B    431  1     2</span></a>
<a class="sourceLine" id="cb6-21" title="21"><span class="co">#&gt; 1 9B06188C-F4C7-436C-8108-3956D5FFD5CD    513  2     2</span></a>
<a class="sourceLine" id="cb6-22" title="22"><span class="co">#&gt; 2 B03DB3BD-0E33-4E10-A935-997832752609    740  3     2</span></a>
<a class="sourceLine" id="cb6-23" title="23"><span class="co">#&gt; 3 D968F174-FB80-404A-A4A7-2862CC722482    573  4     2</span></a>
<a class="sourceLine" id="cb6-24" title="24"><span class="co">#&gt; 4 1FDBFCFF-799C-41CF-A2CB-8A56368BD438     29  5     2</span></a>
<a class="sourceLine" id="cb6-25" title="25"><span class="co">#&gt; 5 D3A1AEA9-93A6-4ACF-9A11-363F9517723F    413  6     2</span></a></code></pre></div>
<p>The resulting data can be plotted using standard <code>raster</code> package commands</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1">raster<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>(brck[[<span class="st">'dem'</span>]])</a>
<a class="sourceLine" id="cb7-2" title="2">raster<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>(chn,<span class="dt">add=</span><span class="ot">TRUE</span>)</a></code></pre></div>
<p><img src="dynatopGIS_files/figure-html/plot_raw-1.png" width="700"></p>
</div>
<div id="combining-the-river-network-and-dem" class="section level1">
<h1 class="hasAnchor">
<a href="#combining-the-river-network-and-dem" class="anchor"></a>Combining the river network and DEM</h1>
<p>Having initialised the analysis the next stage is to combine the DEm and channel network. The <code>add_channel</code> function achieves this by intersecting the DEM and river network to determine which of the raster cells contain parts of the river network. From this three layers of the brick are populated: - land_area - the area in the DEM cell covered by land - channel_area - the area in the DEM cell covered by channel - channel_id - the id of the channel within the cell, corresponding to the id in the channel object.</p>
<p>If multiple river lengths intersect a DEM cell the properties of the channel length with the largest area of intersection are used.</p>
<p>The following shows the impact of the properties of the raster brick after applying the channel network in Swindale.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1"><span class="co">#print(brck)</span></a>
<a class="sourceLine" id="cb8-2" title="2"><span class="co">#print(chn)</span></a>
<a class="sourceLine" id="cb8-3" title="3">brck &lt;-<span class="st"> </span><span class="kw"><a href="../reference/add_channel.html">add_channel</a></span>(brck,chn)</a>
<a class="sourceLine" id="cb8-4" title="4"><span class="co">#print(brck)</span></a></code></pre></div>
</div>
<div id="filling-sinks" class="section level1">
<h1 class="hasAnchor">
<a href="#filling-sinks" class="anchor"></a>Filling sinks</h1>
<p>For the hill slope to be connected to the river network the hill slope parts of the DEM must drain to the DEM cells which intersect with the river network.</p>
<p>While no check is enforced on the full connectivity of the catchment a basic requirement is that there are no sinks: that is DEM pixels which are lower then their neighbors and not intersected by the network. The algorithm implemented in the <code>sink_fill</code> function tries to ensure this using a relatively simple iterative algorithm. The execution time of the function is limited by capping the number of iterations of the algorithm, however the algorithm can be restarted and the minimum gradient adjust from the default of 1m in 1km.</p>
<p>For Swindale, where the example DEM is already partially filled the algorithm finishes quickly and the changes in the DEM are minor</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1">brck &lt;-<span class="st"> </span><span class="kw"><a href="../reference/sink_fill.html">sink_fill</a></span>(brck)</a>
<a class="sourceLine" id="cb9-2" title="2"><span class="co">#&gt; Warning in sink_fill(brck): Sink filling is not implimented...this just</span></a>
<a class="sourceLine" id="cb9-3" title="3"><span class="co">#&gt; copies the dem</span></a>
<a class="sourceLine" id="cb9-4" title="4">raster<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>( brck[[<span class="st">'filled_dem'</span>]] <span class="op">-</span><span class="st"> </span>brck[[<span class="st">'dem'</span>]] )</a></code></pre></div>
<p><img src="dynatopGIS_files/figure-html/sink_fill-1.png" width="700"></p>
<div id="computing-summary-properties" class="section level2">
<h2 class="hasAnchor">
<a href="#computing-summary-properties" class="anchor"></a>Computing summary properties</h2>
<p>The basis of separation of the hydrological response units in TOPMODEL is the topographic index, which is computed from the upstream area and gradient.</p>
<p>These are computed using the formulea in Quinn 1991 (TO DO add ref).</p>
<p>The upstream area is computed by routing down slope with the fraction of the area being routed to the next downstream pixel being proportional to the gradient times the contour length.</p>
<p>The local value of the gradient is computed using the average of a subset of between pixel gradients. For a normal ‘hill slope’ cell these are the gradients to downslope pixels weighted by contour length. In the case of pixels which contain river channels the average of the gradients from upslope pixels weighted by contour length us used.</p>
<p>These properties (and others) are computed in an algorithm that passes over the data twice. First to compute identify ‘peaks’ in the dem, dsecondly to travel downslope. It is called as follows</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1">brck &lt;-<span class="st"> </span><span class="kw"><a href="../reference/compute_properties.html">compute_properties</a></span>(brck)</a>
<a class="sourceLine" id="cb10-2" title="2"><span class="co">#&gt; Boundary peak at cell 799</span></a>
<a class="sourceLine" id="cb10-3" title="3"><span class="co">#&gt; Boundary peak at cell 837</span></a>
<a class="sourceLine" id="cb10-4" title="4"><span class="co">#&gt; Boundary peak at cell 29887</span></a>
<a class="sourceLine" id="cb10-5" title="5"><span class="co">#&gt; Boundary peak at cell 31025</span></a>
<a class="sourceLine" id="cb10-6" title="6"><span class="co">#&gt; Boundary peak at cell 45568</span></a>
<a class="sourceLine" id="cb10-7" title="7"><span class="co">#&gt; Boundary peak at cell 45643</span></a>
<a class="sourceLine" id="cb10-8" title="8"><span class="co">#&gt; Boundary peak at cell 75843</span></a>
<a class="sourceLine" id="cb10-9" title="9"><span class="co">#&gt; Boundary peak at cell 104955</span></a>
<a class="sourceLine" id="cb10-10" title="10"><span class="co">#&gt; Boundary peak at cell 135206</span></a>
<a class="sourceLine" id="cb10-11" title="11"><span class="co">#&gt; Boundary peak at cell 153772</span></a>
<a class="sourceLine" id="cb10-12" title="12"><span class="co">#&gt; Boundary peak at cell 153773</span></a>
<a class="sourceLine" id="cb10-13" title="13"><span class="co">#&gt; Boundary peak at cell 166681</span></a>
<a class="sourceLine" id="cb10-14" title="14"><span class="co">#&gt; Boundary peak at cell 181237</span></a>
<a class="sourceLine" id="cb10-15" title="15"><span class="co">#&gt; Boundary peak at cell 227318</span></a>
<a class="sourceLine" id="cb10-16" title="16"><span class="co">#&gt; Boundary peak at cell 243050</span></a>
<a class="sourceLine" id="cb10-17" title="17"><span class="co">#&gt; Boundary peak at cell 272728</span></a>
<a class="sourceLine" id="cb10-18" title="18"><span class="co">#&gt; Boundary peak at cell 304337</span></a>
<a class="sourceLine" id="cb10-19" title="19"><span class="co">#&gt; Boundary peak at cell 309752</span></a>
<a class="sourceLine" id="cb10-20" title="20"><span class="co">#&gt; Boundary peak at cell 332799</span></a>
<a class="sourceLine" id="cb10-21" title="21"><span class="co">#&gt; Boundary peak at cell 365550</span></a>
<a class="sourceLine" id="cb10-22" title="22"><span class="co">#&gt; Boundary peak at cell 394649</span></a>
<a class="sourceLine" id="cb10-23" title="23"><span class="co">#&gt; Boundary peak at cell 409943</span></a>
<a class="sourceLine" id="cb10-24" title="24"><span class="co">#&gt; Boundary peak at cell 423737</span></a>
<a class="sourceLine" id="cb10-25" title="25"><span class="co">#&gt; Boundary peak at cell 425699</span></a>
<a class="sourceLine" id="cb10-26" title="26"><span class="co">#&gt; Boundary peak at cell 439494</span></a>
<a class="sourceLine" id="cb10-27" title="27"><span class="co">#&gt; Boundary peak at cell 454787</span></a>
<a class="sourceLine" id="cb10-28" title="28"><span class="co">#&gt; Boundary peak at cell 515399</span></a>
<a class="sourceLine" id="cb10-29" title="29"><span class="co">#&gt; Boundary peak at cell 546962</span></a>
<a class="sourceLine" id="cb10-30" title="30"><span class="co">#&gt; Boundary peak at cell 561531</span></a>
<a class="sourceLine" id="cb10-31" title="31"><span class="co">#&gt; Boundary peak at cell 561555</span></a>
<a class="sourceLine" id="cb10-32" title="32"><span class="co">#&gt; Boundary peak at cell 607675</span></a>
<a class="sourceLine" id="cb10-33" title="33"><span class="co">#&gt; Boundary peak at cell 713243</span></a>
<a class="sourceLine" id="cb10-34" title="34"><span class="co">#&gt; Boundary peak at cell 773005</span></a>
<a class="sourceLine" id="cb10-35" title="35"><span class="co">#&gt; Boundary peak at cell 773831</span></a>
<a class="sourceLine" id="cb10-36" title="36"><span class="co">#&gt; Boundary peak at cell 788374</span></a>
<a class="sourceLine" id="cb10-37" title="37"><span class="co">#&gt; Boundary peak at cell 802917</span></a>
<a class="sourceLine" id="cb10-38" title="38"><span class="co">#&gt; Boundary peak at cell 804106</span></a>
<a class="sourceLine" id="cb10-39" title="39"><span class="co">#&gt; Boundary peak at cell 833117</span></a>
<a class="sourceLine" id="cb10-40" title="40"><span class="co">#&gt; Boundary peak at cell 848824</span></a>
<a class="sourceLine" id="cb10-41" title="41"><span class="co">#&gt; Boundary peak at cell 848912</span></a>
<a class="sourceLine" id="cb10-42" title="42"><span class="co">#&gt; Boundary peak at cell 864581</span></a>
<a class="sourceLine" id="cb10-43" title="43"><span class="co">#&gt; Boundary peak at cell 955593</span></a>
<a class="sourceLine" id="cb10-44" title="44"><span class="co">#&gt; Boundary peak at cell 970110</span></a>
<a class="sourceLine" id="cb10-45" title="45"><span class="co">#&gt; Boundary peak at cell 971313</span></a>
<a class="sourceLine" id="cb10-46" title="46"><span class="co">#&gt; Boundary peak at cell 984655</span></a>
<a class="sourceLine" id="cb10-47" title="47"><span class="co">#&gt; Boundary peak at cell 1000987</span></a>
<a class="sourceLine" id="cb10-48" title="48"><span class="co">#&gt; Boundary peak at cell 1030075</span></a>
<a class="sourceLine" id="cb10-49" title="49"><span class="co">#&gt; Boundary peak at cell 1030737</span></a>
<a class="sourceLine" id="cb10-50" title="50"><span class="co">#&gt; Boundary peak at cell 1045292</span></a>
<a class="sourceLine" id="cb10-51" title="51"><span class="co">#&gt; Boundary peak at cell 1060325</span></a>
<a class="sourceLine" id="cb10-52" title="52"><span class="co">#&gt; Boundary peak at cell 1136581</span></a>
<a class="sourceLine" id="cb10-53" title="53"><span class="co">#&gt; Boundary peak at cell 1151974</span></a>
<a class="sourceLine" id="cb10-54" title="54"><span class="co">#&gt; Boundary peak at cell 1198068</span></a>
<a class="sourceLine" id="cb10-55" title="55"><span class="co">#&gt; Boundary peak at cell 1420103</span></a>
<a class="sourceLine" id="cb10-56" title="56"><span class="co">#&gt; Boundary peak at cell 1421316</span></a>
<a class="sourceLine" id="cb10-57" title="57"><span class="co">#&gt; Boundary peak at cell 1423742</span></a>
<a class="sourceLine" id="cb10-58" title="58"><span class="co">#&gt; Boundary peak at cell 1728111</span></a>
<a class="sourceLine" id="cb10-59" title="59"><span class="co">#&gt; Boundary peak at cell 1729313</span></a>
<a class="sourceLine" id="cb10-60" title="60"><span class="co">#&gt; Boundary peak at cell 1743743</span></a>
<a class="sourceLine" id="cb10-61" title="61"><span class="co">#&gt; Boundary peak at cell 1765671</span></a>
<a class="sourceLine" id="cb10-62" title="62"><span class="co">#&gt; Boundary peak at cell 1765672</span></a>
<a class="sourceLine" id="cb10-63" title="63"><span class="co">#&gt; Boundary peak at cell 1765673</span></a>
<a class="sourceLine" id="cb10-64" title="64"><span class="co">#&gt; Boundary peak at cell 1765674</span></a>
<a class="sourceLine" id="cb10-65" title="65"><span class="co">#&gt; Boundary peak at cell 1765675</span></a>
<a class="sourceLine" id="cb10-66" title="66"><span class="co">#&gt; Boundary peak at cell 1765676</span></a>
<a class="sourceLine" id="cb10-67" title="67"><span class="co">#&gt; Boundary peak at cell 1765677</span></a>
<a class="sourceLine" id="cb10-68" title="68"><span class="co">#&gt; Boundary peak at cell 1765678</span></a>
<a class="sourceLine" id="cb10-69" title="69"><span class="co">#&gt; Boundary peak at cell 1765679</span></a>
<a class="sourceLine" id="cb10-70" title="70"><span class="co">#&gt; Boundary peak at cell 1765680</span></a>
<a class="sourceLine" id="cb10-71" title="71"><span class="co">#&gt; Boundary peak at cell 1765681</span></a>
<a class="sourceLine" id="cb10-72" title="72"><span class="co">#&gt; Boundary peak at cell 1765682</span></a>
<a class="sourceLine" id="cb10-73" title="73"><span class="co">#&gt; Boundary peak at cell 1773669</span></a>
<a class="sourceLine" id="cb10-74" title="74"><span class="co">#&gt; Boundary peak at cell 1788537</span></a>
<a class="sourceLine" id="cb10-75" title="75"><span class="co">#&gt; Boundary peak at cell 1849137</span></a>
<a class="sourceLine" id="cb10-76" title="76"><span class="co">#&gt; Boundary peak at cell 1946139</span></a>
<a class="sourceLine" id="cb10-77" title="77"><span class="co">#&gt; got to populate</span></a>
<a class="sourceLine" id="cb10-78" title="78"><span class="co">#&gt; 1594</span></a>
<a class="sourceLine" id="cb10-79" title="79"><span class="co">#&gt; got to output</span></a>
<a class="sourceLine" id="cb10-80" title="80"><span class="co">#&gt; [1] "order"</span></a>
<a class="sourceLine" id="cb10-81" title="81"><span class="co">#&gt; [1] "upslope_area"</span></a>
<a class="sourceLine" id="cb10-82" title="82"><span class="co">#&gt; [1] "contour_length"</span></a>
<a class="sourceLine" id="cb10-83" title="83"><span class="co">#&gt; [1] "gradient"</span></a>
<a class="sourceLine" id="cb10-84" title="84"><span class="co">#&gt; [1] "atanb"</span></a>
<a class="sourceLine" id="cb10-85" title="85"><span class="co">## plot of topographic index (log(a/tan b))</span></a>
<a class="sourceLine" id="cb10-86" title="86">raster<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>( brck[[<span class="st">'atanb'</span>]])</a></code></pre></div>
<p><img src="dynatopGIS_files/figure-html/calc_atb-1.png" width="700"></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1"><span class="co">## plot of order of pixels (1 highest)</span></a>
<a class="sourceLine" id="cb11-2" title="2">raster<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>( brck[[<span class="st">'order'</span>]] )</a></code></pre></div>
<p><img src="dynatopGIS_files/figure-html/calc_atb-2.png" width="700"></p>
</div>
<div id="splitting-into-hydrological-response-units" class="section level2">
<h2 class="hasAnchor">
<a href="#splitting-into-hydrological-response-units" class="anchor"></a>Splitting into Hydrological response units</h2>
<p>Hill slope hydrological response units can be created from the underlying data in two ways within the <code>dynatopGIS</code> package. The first method, <em>splitting</em> allows the landscape to be divided up based on breaks in the values of landscape feature values. The second <em>burning</em> enforces classes onto distinct area. It is presumed that burnt classes will always be imposed upon an initial characterization through splitting.</p>
<div id="splitting" class="section level3">
<h3 class="hasAnchor">
<a href="#splitting" class="anchor"></a>Splitting</h3>
<p>To split a catchment into HRUs the breaks between the classes need to be specified. This is done by forming a named <code>list</code> of cuts. the names correspond to GeoTiff files within the project directory while the values of the variables should be numeric and define either the number of bands (single value) or breaks between split classes (multiple values).</p>
<p>For example to generate HRUs for Swindale by dividing the topographic index into 21 classes and save the output classes as “atb_split.tif” in the project folder:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1">cuts &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">atanb=</span><span class="dv">20</span>)</a>
<a class="sourceLine" id="cb12-2" title="2">brck &lt;-<span class="st"> </span><span class="kw"><a href="../reference/split_to_class.html">split_to_class</a></span>(brck,<span class="st">'atb_split'</span>,cuts)</a>
<a class="sourceLine" id="cb12-3" title="3">raster<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>( brck[[<span class="st">'atb_split'</span>]] )</a></code></pre></div>
<p><img src="dynatopGIS_files/figure-html/atb_split-1.png" width="700"></p>
<p>More complex splits can be carried out by specifying all break points. for example to divide by topographic index and stream order</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1">cuts &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">atanb=</span><span class="dv">20</span>,</a>
<a class="sourceLine" id="cb13-2" title="2">             <span class="dt">order=</span><span class="dv">0</span><span class="op">:</span>(raster<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/cellStats">cellStats</a></span>(brck[[<span class="st">'order'</span>]],<span class="st">'max'</span>)<span class="op">+</span><span class="dv">1</span>))</a>
<a class="sourceLine" id="cb13-3" title="3">brck &lt;-<span class="st"> </span><span class="kw"><a href="../reference/split_to_class.html">split_to_class</a></span>(brck,<span class="st">'atb_ord_split'</span>,cuts)</a>
<a class="sourceLine" id="cb13-4" title="4">raster<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>( brck[[<span class="st">'atb_ord_split'</span>]] )</a></code></pre></div>
<p><img src="dynatopGIS_files/figure-html/atb_ord_split-1.png" width="700"> TO DO comment of sequential numbering used</p>
</div>
<div id="burns" class="section level3">
<h3 class="hasAnchor">
<a href="#burns" class="anchor"></a>Burns</h3>
<p>Suppose in the above example we want to burn in an additional HRU class for all areas above 500m that aren’t channels.</p>
<p>Firstly we add an additional layer to the brick to which these locations are identified.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1">brck[[<span class="st">'greater_500'</span>]] &lt;-<span class="st"> </span>raster<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/reclassify">reclassify</a></span>(brck[[<span class="st">'filled_dem'</span>]],</a>
<a class="sourceLine" id="cb14-2" title="2">                                            <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/matrix">matrix</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>,<span class="dv">500</span>,<span class="ot">NA</span>,</a>
<a class="sourceLine" id="cb14-3" title="3">                                                     <span class="dv">500</span>,<span class="dv">1000</span>,raster<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/cellStats">cellStats</a></span>(brck[[<span class="st">'atb_split'</span>]],<span class="st">'max'</span>)<span class="op">+</span><span class="dv">1</span>),<span class="dv">2</span>,<span class="dt">byrow=</span><span class="ot">TRUE</span>))</a></code></pre></div>
<p>Note we have given the cells a value of one greater then the maximum value of splits we will burn this into to maintain the sequential numbering of the HRUs</p>
<p>It can then be burnt in as follows</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1">brck &lt;-<span class="st"> </span><span class="kw"><a href="../reference/burn_in_class.html">burn_in_class</a></span>(brck,<span class="st">"atb_split"</span>,<span class="st">"atb_500_split"</span>,<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="st">"greater_500"</span>))</a>
<a class="sourceLine" id="cb15-2" title="2">raster<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>(brck[[<span class="st">"atb_500_split"</span>]])</a></code></pre></div>
<p><img src="dynatopGIS_files/figure-html/burn_in-1.png" width="700"></p>
</div>
</div>
</div>
<div id="generating-a-dynamic-topmodel" class="section level1">
<h1 class="hasAnchor">
<a href="#generating-a-dynamic-topmodel" class="anchor"></a>Generating a dynamic TOPMODEL</h1>
<p>As final stage dynamic TOPMODELs can be generated from the GIS data for use with the <code>dynatop</code> package for simulation. The required model structure is given in the vignettes of <code>dynatop</code>, here we show that an appropriate models can be generated with the <code>compute_model</code> function for a specified set of HRUs.</p>
<p>For example in the case of the division of Swindale by topographic index into 21 classes the resulting model can be generated by</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1">model &lt;-<span class="st"> </span><span class="kw"><a href="../reference/create_model.html">create_model</a></span>(brck,chn,<span class="st">'atb_split'</span>)</a></code></pre></div>
<p>We can then use the duynatop package to check the validity of the model</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1"><span class="co"># dynatop::check_model(model)</span></a></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#principles-behind-dynatopgis">Principles behind dynatopGIS</a></li>
      <li>
<a href="#getting-started">Getting started</a><ul class="nav nav-pills nav-stacked">
<li><a href="#swindale">Swindale</a></li>
      </ul>
</li>
      <li><a href="#initialising-the-gis-objects">Initialising the GIS objects</a></li>
      <li><a href="#combining-the-river-network-and-dem">Combining the river network and DEM</a></li>
      <li>
<a href="#filling-sinks">Filling sinks</a><ul class="nav nav-pills nav-stacked">
<li><a href="#computing-summary-properties">Computing summary properties</a></li>
      <li><a href="#splitting-into-hydrological-response-units">Splitting into Hydrological response units</a></li>
      </ul>
</li>
      <li><a href="#generating-a-dynamic-topmodel">Generating a dynamic TOPMODEL</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Paul Smith.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
