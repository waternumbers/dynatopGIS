<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Building a Dynamic TOPMODEL • dynatopGIS</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Building a Dynamic TOPMODEL">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">dynatopGIS</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.8.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/dynatopGIS.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/sink_filling.html">Filling sinks and gaps in the DEM</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/waternumbers/dynatopGIS">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Building a Dynamic TOPMODEL</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/waternumbers/dynatopGIS/blob/master/../vignettes/dynatopGIS.Rmd"><code>../vignettes/dynatopGIS.Rmd</code></a></small>
      <div class="hidden name"><code>dynatopGIS.Rmd</code></div>

    </div>

    
    
<p>The purpose of this vignette is to provide an outline of the steps needed to build a dynamic TOPMODEL implementation using the dynatopGIS package.</p>
<div id="principles-behind-dynatopgis" class="section level1">
<h1 class="hasAnchor">
<a href="#principles-behind-dynatopgis" class="anchor"></a>Principles behind dynatopGIS</h1>
<p>The dynatopGIS package is designed to work with a structured data flow, where by GIS data are processed through intermediate stages until one or more dynamic TOPMODEL implementations are produced. The processed GIS data are stored within two objects; a RasterStack and a SpatialPolygonsDataFrame.</p>
<p>At any point in the analysis the these two objects can be written to disk and reloaded using the commands within the <code>raster</code> package. There is no formal linkage between the RasterStack and SpatialPolygonsDataFrame object so spurious models may be produced if incorrect file combinations are used. Creating a document such as this vignette which documents the work flow used should significantly enhance the chances of ensuring the work is reproducible.</p>
</div>
<div id="getting-started" class="section level1">
<h1 class="hasAnchor">
<a href="#getting-started" class="anchor"></a>Getting started</h1>
<p>The basis of the analysis are a rasterised Digital Elevation Model (DEM) of the catchment and a vectorised representation of the river network with attributes. Current these can be in any format supported by the <code>raster</code> and <code>sp</code> libraries respectivly.</p>
<p>However within the calculations used for sink filling, flow routing and topographic index calculations the raster DEM is presumed to be projected so that is has square or rectangular cells such that the difference between the cells centers (in meters) does not alter.</p>
<div id="swindale" class="section level2">
<h2 class="hasAnchor">
<a href="#swindale" class="anchor"></a>Swindale</h2>
<p>The use of the dynatopGIS package is demonstrated using data from the Swindale catchment in the UK. This is included in the external data directory of the package with the following file paths.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(dynatopGIS)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="co">##devtools::load_all("/home/paul/Documents/Software/dynamic_topmodel/dynatopGIS")</span></span>
<span id="cb1-3"><a href="#cb1-3"></a>dem_file &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"extdata"</span>, <span class="st">"SwindaleDTM4mFilled.tif"</span>, <span class="dt">package=</span><span class="st">"dynatopGIS"</span>)</span>
<span id="cb1-4"><a href="#cb1-4"></a>channel_file &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"extdata"</span>, <span class="st">"SwindaleRiverNetwork.shp"</span>, <span class="dt">package=</span><span class="st">"dynatopGIS"</span>)</span></code></pre></div>
</div>
</div>
<div id="initialising-the-gis-objects" class="section level1">
<h1 class="hasAnchor">
<a href="#initialising-the-gis-objects" class="anchor"></a>Initialising the GIS objects</h1>
<p>The package contains functions to correctly initialise the GIS objects populated during the analysis.</p>
<p>In the case of the RasterStack the initialisation function takes the DEM (either as a rasterLayer or file name). The stack in initialised by calling <code>create_brick</code> as follow</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a>stck &lt;-<span class="st"> </span><span class="kw"><a href="../reference/catchment_file.html">create_catchment</a></span>(dem_file)</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="co">#&gt; Loading required namespace: igraph</span></span></code></pre></div>
<p>The returned RasterStack has a number of layers</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(stck)</span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="co">#&gt;  [1] "dem"            "filled_dem"     "land_area"      "channel_area"  </span></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="co">#&gt;  [5] "channel_id"     "atanb"          "gradient"       "upslope_area"  </span></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="co">#&gt;  [9] "contour_length" "order"</span></span></code></pre></div>
<p>These are the minimum requirements for a catchment descriptiiona and are populated in the following steps. The projection information is taken from the DEM.</p>
<p>Reading the river channel data data is more complex. Each vector object in the GIS file of channel information is treated as a length of river reach and requires the following properties</p>
<ul>
<li>
<em>endNode</em> - a label for the downstream end of the river length</li>
<li>
<em>startNode</em> - a label for the upstream end of the river length</li>
<li>
<em>length</em> - the length in meters</li>
</ul>
<p>Additional proporties are currently ignored with two exceptions: - <em>id</em> - this is overwrittem with a warning and used internally - <em>width</em> - if the channel is specified a line sections then the <em>width</em> property is used to buffer the lines to create channle polygons.</p>
<p>Since it is possible that these properties are present in the current data but under different names the <code>create_channel</code> function allows for renaming. To illustrate this let us examine the river network for Swindale</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>shp &lt;-<span class="st"> </span>rgdal<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/rgdal/man/readOGR.html">readOGR</a></span>(channel_file)</span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="co">#&gt; OGR data source with driver: ESRI Shapefile </span></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="co">#&gt; Source: "C:\Users\d251l\AppData\Local\Temp\RtmpAZqHlj\temp_libpath12e7c58912429\dynatopGIS\extdata\SwindaleRiverNetwork.shp", layer: "SwindaleRiverNetwork"</span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="co">#&gt; with 19 features</span></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="co">#&gt; It has 11 fields</span></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="co">#&gt; Integer64 fields read as strings:  length</span></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="co">#&gt; Warning in rgdal::readOGR(channel_file): Z-dimension discarded</span></span>
<span id="cb4-8"><a href="#cb4-8"></a><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(shp)</span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="co">#&gt; class       : SpatialLinesDataFrame </span></span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="co">#&gt; features    : 6 </span></span>
<span id="cb4-11"><a href="#cb4-11"></a><span class="co">#&gt; extent      : 349884.5, 351675.7, 508614.5, 513074.7  (xmin, xmax, ymin, ymax)</span></span>
<span id="cb4-12"><a href="#cb4-12"></a><span class="co">#&gt; crs         : +proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +datum=OSGB36 +units=m +no_defs +ellps=airy +towgs84=446.448,-125.157,542.060,0.1502,0.2470,0.8421,-20.4894 </span></span>
<span id="cb4-13"><a href="#cb4-13"></a><span class="co">#&gt; variables   : 11</span></span>
<span id="cb4-14"><a href="#cb4-14"></a><span class="co">#&gt; names       :         name1,                           identifier,                            startNode,                              endNode,        form,         flow, fictitious, length, name2, sinkdepth,    Shape_Leng </span></span>
<span id="cb4-15"><a href="#cb4-15"></a><span class="co">#&gt; min values  : Hawthorn Gill, 16D0AC09-E0B6-4727-83B8-567E8DE9C533, 1FDBFCFF-799C-41CF-A2CB-8A56368BD438, 1FDBFCFF-799C-41CF-A2CB-8A56368BD438, inlandRiver, in direction,      false,     29,    NA,        -1, 29.1895135281 </span></span>
<span id="cb4-16"><a href="#cb4-16"></a><span class="co">#&gt; max values  : Mosedale Beck, ED03FEDD-0F4B-40C7-86E8-6F0EA8BAC182, D968F174-FB80-404A-A4A7-2862CC722482, D649B60C-E631-47FA-971E-CA388DBDDE63, inlandRiver, in direction,      false,    740,    NA,        -1,  739.76377764</span></span></code></pre></div>
<p>The main properties are present under appropriate names and a call to <code>create_channel</code> with no options would be successful. However if we want to carry over the addition information in the “indentifier” as “channel_id” a named vector giving the variable names to be used could be provided. In this case:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>property_names &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dt">channel_id=</span><span class="st">"identifier"</span>,</span>
<span id="cb5-2"><a href="#cb5-2"></a>                    <span class="dt">endNode=</span><span class="st">"endNode"</span>,</span>
<span id="cb5-3"><a href="#cb5-3"></a>                    <span class="dt">startNode=</span><span class="st">"startNode"</span>,</span>
<span id="cb5-4"><a href="#cb5-4"></a>                    <span class="dt">length=</span><span class="st">"length"</span>)</span></code></pre></div>
<p>Since the data set for Swindale does not contain a channel width we use the default width of 2m in <code>create_channel</code>. The river network can then be created in the correct format by</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>chn &lt;-<span class="st"> </span><span class="kw"><a href="../reference/create_channel.html">create_channel</a></span>(shp,property_names)</span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="co">#&gt; Warning in create_channel(shp, property_names): Modifying to spatial polygons</span></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="co">#&gt; using default width</span></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(chn<span class="op">@</span>data)</span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="co">#&gt;                             channel_id                              endNode</span></span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="co">#&gt; 0 16D0AC09-E0B6-4727-83B8-567E8DE9C533 72B1A40B-E106-42A9-A261-4B7720037ADB</span></span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="co">#&gt; 1 643017BB-01BC-4738-898F-1C62B84164BF A19E0D3A-2FA1-4E6D-AEA4-472F91ABC2AC</span></span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="co">#&gt; 2 D2C2703E-A32F-4D88-A022-4E27EA52FC5C D649B60C-E631-47FA-971E-CA388DBDDE63</span></span>
<span id="cb6-9"><a href="#cb6-9"></a><span class="co">#&gt; 3 991D9896-CA0C-492F-A6EE-8BA3972DDA3C 1FDBFCFF-799C-41CF-A2CB-8A56368BD438</span></span>
<span id="cb6-10"><a href="#cb6-10"></a><span class="co">#&gt; 4 CC8639D7-00D2-4C26-9252-350E5A748D51 7C251581-3764-4DEE-8031-EC98FABC1F87</span></span>
<span id="cb6-11"><a href="#cb6-11"></a><span class="co">#&gt; 5 ED03FEDD-0F4B-40C7-86E8-6F0EA8BAC182 673269DF-9E48-4EA0-B439-3D565A023DD2</span></span>
<span id="cb6-12"><a href="#cb6-12"></a><span class="co">#&gt;                              startNode length id width</span></span>
<span id="cb6-13"><a href="#cb6-13"></a><span class="co">#&gt; 0 730F01D2-0F4F-4E27-AF55-B1782F0F844B    431  1     2</span></span>
<span id="cb6-14"><a href="#cb6-14"></a><span class="co">#&gt; 1 9B06188C-F4C7-436C-8108-3956D5FFD5CD    513  2     2</span></span>
<span id="cb6-15"><a href="#cb6-15"></a><span class="co">#&gt; 2 B03DB3BD-0E33-4E10-A935-997832752609    740  3     2</span></span>
<span id="cb6-16"><a href="#cb6-16"></a><span class="co">#&gt; 3 D968F174-FB80-404A-A4A7-2862CC722482    573  4     2</span></span>
<span id="cb6-17"><a href="#cb6-17"></a><span class="co">#&gt; 4 1FDBFCFF-799C-41CF-A2CB-8A56368BD438     29  5     2</span></span>
<span id="cb6-18"><a href="#cb6-18"></a><span class="co">#&gt; 5 D3A1AEA9-93A6-4ACF-9A11-363F9517723F    413  6     2</span></span></code></pre></div>
<p>The resulting data can be plotted using standard <code>raster</code> package commands</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>raster<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span>(stck[[<span class="st">'dem'</span>]])</span>
<span id="cb7-2"><a href="#cb7-2"></a>raster<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span>(chn,<span class="dt">add=</span><span class="ot">TRUE</span>)</span></code></pre></div>
<p><img src="dynatopGIS_files/figure-html/plot_raw-1.png" width="700"></p>
</div>
<div id="combining-the-river-network-and-dem" class="section level1">
<h1 class="hasAnchor">
<a href="#combining-the-river-network-and-dem" class="anchor"></a>Combining the river network and DEM</h1>
<p>Having initialised the analysis the next stage is to combine the DEm and channel network. The <code>add_channel</code> function achieves this by intersecting the DEM and river network to determine which of the raster cells contain parts of the river network. From this three layers of the brick are populated: - land_area - the area in the DEM cell covered by land - channel_area - the area in the DEM cell covered by channel - channel_id - the id of the channel within the cell, corresponding to the id in the channel object.</p>
<p>If multiple river lengths intersect a DEM cell the properties of the channel length with the largest area of intersection are used.</p>
<p>The following shows the impact of the properties of the raster brick after applying the channel network in Swindale.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="co">#print(stck)</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="co">#print(chn)</span></span>
<span id="cb8-3"><a href="#cb8-3"></a>stck &lt;-<span class="st"> </span><span class="kw"><a href="../reference/add_channel.html">add_channel</a></span>(stck,chn)</span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="co">#print(stck)</span></span></code></pre></div>
</div>
<div id="filling-sinks" class="section level1">
<h1 class="hasAnchor">
<a href="#filling-sinks" class="anchor"></a>Filling sinks</h1>
<p>For the hill slope to be connected to the river network the hill slope parts of the DEM must drain to the DEM cells which intersect with the river network.</p>
<p>While no check is enforced on the full connectivity of the catchment a basic requirement is that there are no sinks: that is DEM pixels which are lower then their neighbors and not intersected by the network. The algorithm implemented in the <code>sink_fill</code> function tries to ensure this using a relatively simple iterative algorithm. The execution time of the function is limited by capping the number of iterations of the algorithm, however the algorithm can be restarted and the minimum gradient adjust from the default of 1m in 1km.</p>
<p>For Swindale, where the example DEM is already partially filled the algorithm finishes quickly and the changes in the DEM are minor</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>stck &lt;-<span class="st"> </span><span class="kw"><a href="../reference/sink_fill.html">sink_fill</a></span>(stck)</span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="co">#&gt; [1] 0</span></span>
<span id="cb9-3"><a href="#cb9-3"></a>raster<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span>( stck[[<span class="st">'filled_dem'</span>]] <span class="op">-</span><span class="st"> </span>stck[[<span class="st">'dem'</span>]] )</span></code></pre></div>
<p><img src="dynatopGIS_files/figure-html/sink_fill-1.png" width="700"></p>
<div id="computing-summary-properties" class="section level2">
<h2 class="hasAnchor">
<a href="#computing-summary-properties" class="anchor"></a>Computing summary properties</h2>
<p>The basis of separation of the hydrological response units in TOPMODEL is the topographic index, which is computed from the upstream area and gradient.</p>
<p>These are computed using the formulea in Quinn 1991 (TO DO add ref).</p>
<p>The upstream area is computed by routing down slope with the fraction of the area being routed to the next downstream pixel being proportional to the gradient times the contour length.</p>
<p>The local value of the gradient is computed using the average of a subset of between pixel gradients. For a normal ‘hill slope’ cell these are the gradients to downslope pixels weighted by contour length. In the case of pixels which contain river channels the average of the gradients from upslope pixels weighted by contour length us used.</p>
<p>These properties (and others) are computed in an algorithm that passes over the data twice. First to compute identify ‘peaks’ in the dem, dsecondly to travel downslope. It is called as follows</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>stck &lt;-<span class="st"> </span><span class="kw"><a href="../reference/compute_properties.html">compute_properties</a></span>(stck)</span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="co">#&gt; [1] 2753</span></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="co">## plot of topographic index (log(a/tan b))</span></span>
<span id="cb10-4"><a href="#cb10-4"></a>raster<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span>( stck[[<span class="st">'atanb'</span>]])</span></code></pre></div>
<p><img src="dynatopGIS_files/figure-html/calc_atb-1.png" width="700"></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="co">## plot of order of pixels (1 highest)</span></span>
<span id="cb11-2"><a href="#cb11-2"></a>raster<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span>( stck[[<span class="st">'order'</span>]] )</span></code></pre></div>
<p><img src="dynatopGIS_files/figure-html/calc_atb-2.png" width="700"></p>
</div>
<div id="splitting-into-hydrological-response-units" class="section level2">
<h2 class="hasAnchor">
<a href="#splitting-into-hydrological-response-units" class="anchor"></a>Splitting into Hydrological response units</h2>
<p>Hill slope hydrological response units can be created from the underlying data in two ways within the <code>dynatopGIS</code> package. The first method, <em>splitting</em> allows the landscape to be divided up based on breaks in the values of landscape feature values. The second <em>burning</em> enforces classes onto distinct area. It is presumed that burnt classes will always be imposed upon an initial characterization through splitting.</p>
<div id="splitting" class="section level3">
<h3 class="hasAnchor">
<a href="#splitting" class="anchor"></a>Splitting</h3>
<p>To split a catchment into HRUs the breaks between the classes need to be specified. This is done by forming a named <code>list</code> of cuts. the names correspond to GeoTiff files within the project directory while the values of the variables should be numeric and define either the number of bands (single value) or breaks between split classes (multiple values).</p>
<p>For example to generate HRUs for Swindale by dividing the topographic index into 21 classes and save the output classes as “atb_split.tif” in the project folder:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>cuts &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">atanb=</span><span class="dv">20</span>)</span>
<span id="cb12-2"><a href="#cb12-2"></a>stck &lt;-<span class="st"> </span><span class="kw"><a href="../reference/split_to_class.html">split_to_class</a></span>(stck,<span class="st">'atb_split'</span>,cuts)</span>
<span id="cb12-3"><a href="#cb12-3"></a>raster<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span>( stck[[<span class="st">'atb_split'</span>]] )</span></code></pre></div>
<p><img src="dynatopGIS_files/figure-html/atb_split-1.png" width="700"> TO DO comment of sequential numbering used</p>
</div>
<div id="burns" class="section level3">
<h3 class="hasAnchor">
<a href="#burns" class="anchor"></a>Burns</h3>
<p>Suppose in the above example we want to burn in an additional HRU class for all areas above 500m that aren’t channels.</p>
<p>Firstly we add an additional layer to the brick to which these locations are identified.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>stck[[<span class="st">'greater_500'</span>]] &lt;-<span class="st"> </span>raster<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/raster/man/reclassify.html">reclassify</a></span>(stck[[<span class="st">'filled_dem'</span>]],</span>
<span id="cb13-2"><a href="#cb13-2"></a>                                            <span class="kw"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>,<span class="dv">500</span>,<span class="ot">NA</span>,</span>
<span id="cb13-3"><a href="#cb13-3"></a>                                                     <span class="dv">500</span>,<span class="dv">1000</span>,raster<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/raster/man/cellStats.html">cellStats</a></span>(stck[[<span class="st">'atb_split'</span>]],<span class="st">'max'</span>)<span class="op">+</span><span class="dv">1</span>),<span class="dv">2</span>,<span class="dt">byrow=</span><span class="ot">TRUE</span>))</span></code></pre></div>
<p>Note we have given the cells a value of one greater then the maximum value of splits we will burn this into to maintain the sequential numbering of the HRUs</p>
<p>It can then be burnt in as follows</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>stck &lt;-<span class="st"> </span><span class="kw"><a href="../reference/burn_in_class.html">burn_in_class</a></span>(stck,<span class="st">"atb_split"</span>,<span class="st">"atb_500_split"</span>,<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="st">"greater_500"</span>))</span>
<span id="cb14-2"><a href="#cb14-2"></a>raster<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span>(stck[[<span class="st">"atb_500_split"</span>]])</span></code></pre></div>
<p><img src="dynatopGIS_files/figure-html/burn_in-1.png" width="700"></p>
</div>
</div>
</div>
<div id="generating-a-dynamic-topmodel" class="section level1">
<h1 class="hasAnchor">
<a href="#generating-a-dynamic-topmodel" class="anchor"></a>Generating a dynamic TOPMODEL</h1>
<p>As final stage dynamic TOPMODELs can be generated from the GIS data for use with the <code>dynatop</code> package for simulation. The required model structure is given in the vignettes of <code>dynatop</code>, here we show that an appropriate models can be generated with the <code>compute_model</code> function for a specified set of HRUs.</p>
<p>For example in the case of the division of Swindale by topographic index into 21 classes the resulting model can be generated by</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>model &lt;-<span class="st"> </span><span class="kw"><a href="../reference/create_model.html">create_model</a></span>(stck,chn,<span class="st">'atb_split'</span>)</span></code></pre></div>
<p>We can then use the duynatop package to check the validity of the model</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="co"># dynatop::check_model(model)</span></span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#principles-behind-dynatopgis">Principles behind dynatopGIS</a></li>
      <li>
<a href="#getting-started">Getting started</a><ul class="nav nav-pills nav-stacked">
<li><a href="#swindale">Swindale</a></li>
      </ul>
</li>
      <li><a href="#initialising-the-gis-objects">Initialising the GIS objects</a></li>
      <li><a href="#combining-the-river-network-and-dem">Combining the river network and DEM</a></li>
      <li>
<a href="#filling-sinks">Filling sinks</a><ul class="nav nav-pills nav-stacked">
<li><a href="#computing-summary-properties">Computing summary properties</a></li>
      <li><a href="#splitting-into-hydrological-response-units">Splitting into Hydrological response units</a></li>
      </ul>
</li>
      <li><a href="#generating-a-dynamic-topmodel">Generating a dynamic TOPMODEL</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Paul Smith.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
