## some extra bits for debugging
rm(list=ls())

devtools::load_all()
project_path <- '../../gis_vig'

tmp <- readRDS(file.path(project_path,'atb_split.rds'))
rtmp <- raster::raster(file.path(project_path,'atb_split.tif'))
dem <- raster::raster(file.path(project_path,'filled_dem.tif'))
atb <- raster::raster(file.path(project_path,'atb.tif'))
## see what is up with hillslope class 1

idx <- Which(rtmp==1,cells=TRUE)

jdx <- raster::rowColFromCell(rtmp,idx[1])

jdx <- cbind(jdx[1]+c(0,-1,0,1,-1,1,-1,0,1),jdx[2]+c(0,1,1,1,0,0,-1,-1,-1))
d <- c(0,sqrt(32),4,sqrt(32),4,4,sqrt(32),4,sqrt(32))
rtmp[jdx]
grad <- (dem[jdx]-dem[jdx[1,]])/d